name: Deploy to AWS via Bastion

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/ci-key
          chmod 600 ~/.ssh/ci-key

      - name: Add bastion to known_hosts
        run: ssh-keyscan -H ${{ secrets.BASTION_HOST }} >> ~/.ssh/known_hosts

      - name: SSH into Bastion and deploy on Private EC2
        run: |
          ssh -i ~/.ssh/ci-key -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.BASTION_HOST }} "
              # از روی Bastion با کلید داخلی خودش به سرور خصوصی وصل می‌شویم
              ssh -o StrictHostKeyChecking=no -i ~/.ssh/aws-key ubuntu@${{ secrets.PRIVATE_EC2_IP }} '
                cd ~/flask-app &&
                git pull origin main &&
                docker compose down &&
                docker compose up -d --build
              '
            "
